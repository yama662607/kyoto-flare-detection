# =============================================================================
# âš™ï¸ è¨­å®šã¨å¤‰æ•°
# =============================================================================

set dotenv-load := true
set shell := ["bash", "-c"]

# Python ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ•°

src_dir := "src"
test_dir := "tests"

# =============================================================================
# ðŸ¤– æ¨™æº–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ—ãƒ­ãƒˆã‚³ãƒ«)
# =============================================================================

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: èª­ã¿å–ã‚Šå°‚ç”¨ã®å…¨ä»¶ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
default: check

# ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: ä¾å­˜é–¢ä¿‚ã¨ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
setup:
    @echo "ðŸ“¦ ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
    uv sync --all-extras

# å®Œå…¨ãªå“è³ªç¢ºèª (CI ã‚²ãƒ¼ãƒˆ)
check: fmt-check lint test
    @echo "âœ… ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸï¼"

# è‡ªå‹•ä¿®æ­£: ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã¨ãƒªãƒ³ã‚¿ãƒ¼ã®ä¿®æ­£ã‚’é©ç”¨
fix: fmt lint-fix
    @echo "âœ¨ è‡ªå‹•ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã—ãŸï¼"

# =============================================================================
# ðŸ§ª ãƒ†ã‚¹ãƒˆã¨æ¤œè¨¼
# =============================================================================
# ãƒ¦ãƒ‹ãƒƒãƒˆ/çµ±åˆãƒ†ã‚¹ãƒˆ: å¼•æ•°ã®å—ã‘æ¸¡ã—ã«å¯¾å¿œ

# ä½¿ç”¨ä¾‹: just test (å…¨ä»¶) | just test path/to/file (ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«)
test *args="":
    @echo "ðŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
    @if [ -d "{{ test_dir }}" ]; then \
        uv run pytest {{ args }}; \
    else \
        echo "âš ï¸  ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"; \
    fi

# E2E ãƒ†ã‚¹ãƒˆ: å¼•æ•°ã®å—ã‘æ¸¡ã—ã«å¯¾å¿œ
e2e *args="":
    @echo "ðŸŽ­ E2E ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
    @echo "âš ï¸  ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ E2E ãƒ†ã‚¹ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

# =============================================================================
# ðŸ§© è©³ç´°ã‚¿ã‚¹ã‚¯ ('check' ã¨ 'fix' ã®æ§‹æˆè¦ç´ )
# =============================================================================
# --- ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ ---

fmt-check:
    @echo "ðŸ“ ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    uv run ruff format --check {{ src_dir }}

fmt:
    @echo "ðŸ’… ã‚³ãƒ¼ãƒ‰ã‚’æ•´å½¢ä¸­..."
    uv run ruff format {{ src_dir }}

# --- ãƒªãƒ³ã‚¿ãƒ¼ ---

lint:
    @echo "ðŸ” é™çš„è§£æžã‚’å®Ÿè¡Œä¸­..."
    uv run ruff check {{ src_dir }}

lint-fix:
    @echo "ðŸ§¹ ãƒªãƒ³ã‚¿ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ã‚’å®Ÿè¡Œä¸­..."
    uv run ruff check --fix {{ src_dir }}

# --- åž‹ãƒã‚§ãƒƒã‚¯ ---

typecheck:
    @echo "ðŸ“ åž‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    @echo "âš ï¸  åž‹ãƒã‚§ãƒƒã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ (mypy ãŒä¾å­˜é–¢ä¿‚ã«ã‚ã‚Šã¾ã›ã‚“)ã€‚"

# =============================================================================
# ðŸ› ï¸ é‹ç”¨ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
# =============================================================================

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
dev:
    @echo "ðŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
    @echo "âš ï¸  é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

# æœ¬ç•ªãƒ“ãƒ«ãƒ‰
build:
    @echo "ðŸ—ï¸ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    @echo "âš ï¸  ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"

# ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®å‰Šé™¤
clean:
    @echo "ðŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ç”Ÿæˆç‰©ã‚’å‰Šé™¤ä¸­..."
    rm -rf .ruff_cache .pytest_cache .mypy_cache __pycache__ .coverage htmlcov
    find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
